before_script:
  - apt-get update -yq
  - DEBIAN_FRONTEND="noninteractive" apt-get install -y make quilt wget curl

stages:
  - build
  - upload
  - release

default:
  image: ubuntu:latest

variables:
  GIT_SUBMODULE_STRATEGY: recursive
  VERSION: "${CI_COMMIT_TAG}"
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/chromium-ppc64le-patches-quilt/${VERSION}"

build:
  stage: build

  only:
    - tags

  tags:
    - docker

  script:
    - make dist

  artifacts:
    paths:
      - target/patches-*.tar.gz

upload:
  stage: upload

  only:
    - tags

  tags:
    - ppc64le
    - docker

  script:
    - chmod +x ./upload.sh
    - ./upload.sh

release:
  stage: release

  tags:
    - ppc64le
    - docker

  only:
    - tags

  script:
    - chmod +x ./release.sh
    - ./release.sh
